<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è¯´åˆ†æç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 50%, #f0f8ff 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        
        .header {
            background: linear-gradient(135deg, #a8e6cf 0%, #88d8c0 50%, #7fcdcd 100%);
            color: #2d3748;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.8;
            color: #4a5568;
        }
        
        .nav {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            background: #f7fafc;
        }
        
        .nav-item {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .nav-item:hover {
            background: #edf2f7;
            color: #2d3748;
        }
        
        .nav-item.active {
            background: white;
            border-bottom-color: #68d391;
            color: #2d3748;
            font-weight: 600;
        }
        
        .content {
            padding: 30px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .upload-area {
            border: 3px dashed #4facfe;
            border-radius: 12px;
            padding: 60px 30px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: #f8f9ff;
        }
        
        .upload-area.dragover {
            border-color: #28a745;
            background: #f0fff4;
        }
        
        .upload-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #4facfe;
        }
        
        .btn {
            background: linear-gradient(135deg, #a8e6cf 0%, #88d8c0 100%);
            color: #2d3748;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            will-change: transform;
        }
        
        .btn:hover {
            transform: translateY(-2px) translateZ(0);
            box-shadow: 0 8px 16px rgba(168, 230, 207, 0.4);
            background: linear-gradient(135deg, #b8f0d1 0%, #98e0d0 100%);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #feb2b2 0%, #fc8181 100%);
            color: #742a2a;
        }
        
        .btn-danger:hover {
            box-shadow: 0 8px 16px rgba(254, 178, 178, 0.4);
            background: linear-gradient(135deg, #fed7d7 0%, #fbb6ce 100%);
        }
        
        .novel-card {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        }
        
        .novel-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        }
        
        /* æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨will-changeå’Œtransform3d */
        .novel-card {
            will-change: transform;
            transform: translateZ(0);
        }
        
        /* ä¼˜åŒ–åŠ¨ç”»æ€§èƒ½ */
        * {
            box-sizing: border-box;
        }
        
        /* å‡å°‘é‡ç»˜çš„ä¼˜åŒ– */
        .analysis-item {
            contain: layout style paint;
        }
        
        /* ä¼˜åŒ–æ»šåŠ¨æ€§èƒ½ */
        .analysis-content {
            contain: layout;
            overflow: auto;
        }
        
        .novel-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .novel-meta {
            color: #6c757d;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-left: 10px;
        }
        
        .status-completed {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .status-processing {
            background: #fef5e7;
            color: #744210;
        }
        
        .status-pending {
            background: #e6fffa;
            color: #234e52;
        }
        
        .status-failed {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .analysis-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .analysis-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .analysis-tab.active {
            border-bottom-color: #68d391;
            color: #2d3748;
            font-weight: 600;
        }
        
        .analysis-content {
            display: none;
        }
        
        .analysis-content.active {
            display: block;
        }
        
        .analysis-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .analysis-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .analysis-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            border: 1px solid #e1e5e9;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #4facfe;
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-container {
            margin: 20px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 25px;
            background-color: #f0f0f0;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #68d391, #81e6d9, #f6e05e);
            transition: width 0.5s ease;
            position: relative;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) translateZ(0); }
            100% { transform: translateX(100%) translateZ(0); }
        }
        
        .progress-text {
            text-align: center;
            font-weight: bold;
            color: #333;
            font-size: 16px;
            margin-top: 5px;
        }
        
        .progress-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .progress-step, .progress-status, .progress-message, .progress-time {
            display: flex;
            margin-bottom: 8px;
            align-items: flex-start;
        }
        
        .step-label, .status-label, .message-label, .time-label {
            font-weight: bold;
            color: #666;
            min-width: 80px;
            margin-right: 10px;
        }
        
        .step-value, .status-value, .message-value, .time-value {
            color: #333;
            flex: 1;
            word-break: break-word;
        }
        
        .status-processing {
            color: #2196F3;
            font-weight: bold;
        }
        
        .status-completed {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .status-failed {
            color: #f44336;
            font-weight: bold;
        }
        
        .progress-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #68d391 0%, #81e6d9 100%);
            color: #2d3748;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #a0aec0 0%, #cbd5e0 100%);
            color: #2d3748;
        }
        
        .btn-info {
            background: linear-gradient(135deg, #63b3ed 0%, #90cdf4 100%);
            color: #2d3748;
        }
        
        .progress-tips {
            background: #f0fff4;
            padding: 10px;
            border-radius: 8px;
            border-left: 4px solid #68d391;
        }
        
        .progress-tips p {
            margin: 0;
            color: #22543d;
            font-size: 14px;
        }
        
        /* åˆ†é¡µæ ·å¼ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            color: #333;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .pagination-btn:hover {
            background: #f8f9fa;
            border-color: #007bff;
        }
        
        .pagination-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-ellipsis {
            padding: 8px 4px;
            color: #6c757d;
            font-weight: bold;
        }
        
        .pagination-info {
            text-align: center;
            color: #6c757d;
            font-size: 14px;
            margin-top: 10px;
        }
        
        #chapter-pagination-container {
            margin-top: 20px;
        }
        
        #chapter-list {
            min-height: 200px;
        }
        
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .pagination-settings {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .pagination-settings label {
            font-weight: bold;
            color: #495057;
            margin: 0;
        }
        
        .pagination-settings select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            color: #333;
            font-size: 14px;
        }
        
        .pagination-settings select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        
        .progress-details p {
            margin: 5px 0;
            color: #495057;
        }
        
        .progress-actions {
            text-align: center;
            margin-top: 15px;
        }
        
        .progress-actions .btn {
            margin: 0 5px;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #495057;
        }
        
        .close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }
        
        .close:hover {
            color: #495057;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .tag {
            background: #4facfe;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“š å°è¯´åˆ†æç³»ç»Ÿ</h1>
            <p>åŸºäºå¤§æ¨¡å‹çš„å°è¯´åˆ†å±‚ç»“æ„åŒ–åˆ†æå¹³å°</p>
        </div>
        
        <div class="nav">
            <div class="nav-item active" data-tab="upload">ğŸ“¤ ä¸Šä¼ åˆ†æ</div>
            <div class="nav-item" data-tab="novels">ğŸ“– å°è¯´åˆ—è¡¨</div>
            <div class="nav-item" data-tab="analysis">ğŸ“Š åˆ†æè¯¦æƒ…</div>
        </div>
        
        <div class="content">
            <!-- ä¸Šä¼ åˆ†æé¡µé¢ -->
            <div id="upload-tab" class="tab-content active">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ğŸ“</div>
                    <h3>æ‹–æ‹½å°è¯´æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©</h3>
                    <p>æ”¯æŒ .txt æ ¼å¼æ–‡ä»¶</p>
                    <input type="file" id="fileInput" accept=".txt" style="display: none;">
                    <button class="btn" onclick="document.getElementById('fileInput').click()">é€‰æ‹©æ–‡ä»¶</button>
                </div>
                
                <div class="input-group">
                    <label for="novelTitle">å°è¯´æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="novelTitle" placeholder="å¦‚ä¸å¡«å†™å°†ä½¿ç”¨æ–‡ä»¶å">
                </div>
                
                <div id="uploadStatus"></div>
            </div>
            
            <!-- å°è¯´åˆ—è¡¨é¡µé¢ -->
            <div id="novels-tab" class="tab-content">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                    <h2>ğŸ“š å°è¯´åº“</h2>
                    <button class="btn" onclick="loadNovels()">ğŸ”„ åˆ·æ–°</button>
                </div>
                
                <div id="novelsList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>
            </div>
            
            <!-- åˆ†æè¯¦æƒ…é¡µé¢ -->
            <div id="analysis-tab" class="tab-content">
                <div id="analysisContainer">
                    <div style="text-align: center; padding: 50px; color: #6c757d;">
                        <h3>è¯·å…ˆé€‰æ‹©ä¸€æœ¬å°è¯´æŸ¥çœ‹åˆ†æç»“æœ</h3>
                        <p>ä»å°è¯´åˆ—è¡¨ä¸­é€‰æ‹©å·²å®Œæˆåˆ†æçš„å°è¯´</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentNovelId = null;
        let currentAnalysisLevel = 'book';
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            loadNovels();
            
            // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ä¼˜åŒ–æ€§èƒ½
            document.addEventListener('click', function(e) {
                if (e.target.matches('.pagination-btn')) {
                    const page = parseInt(e.target.textContent);
                    if (!isNaN(page)) {
                        changeChapterPage(page);
                    }
                }
            });
        });
        
        // äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–
        function initializeEventListeners() {
            // å¯¼èˆªæ ‡ç­¾åˆ‡æ¢
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
            
            // æ–‡ä»¶ä¸Šä¼ 
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');
            
            fileInput.addEventListener('change', handleFileSelect);
            
            // æ‹–æ‹½åŠŸèƒ½
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    handleFileSelect();
                }
            });
        }
        
        // æ ‡ç­¾åˆ‡æ¢
        function switchTab(tabName) {
            // æ›´æ–°å¯¼èˆª
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // æ›´æ–°å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // ç‰¹æ®Šå¤„ç†
            if (tabName === 'novels') {
                loadNovels();
            }
        }
        
        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            if (!file.name.endsWith('.txt')) {
                showAlert('error', 'è¯·é€‰æ‹© .txt æ ¼å¼çš„æ–‡ä»¶');
                return;
            }
            
            uploadNovel(file);
        }
        
        // ä¸Šä¼ å°è¯´
        async function uploadNovel(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            const title = document.getElementById('novelTitle').value;
            if (title) {
                formData.append('title', title);
            }
            
            try {
                showUploadStatus('uploading');
                
                const response = await fetch('/api/novels/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showUploadStatus('success', result.message, result.novel_id);
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('fileInput').value = '';
                    document.getElementById('novelTitle').value = '';
                    // åˆ·æ–°åˆ—è¡¨
                    loadNovels();
                } else {
                    showUploadStatus('error', result.detail || 'ä¸Šä¼ å¤±è´¥');
                }
            } catch (error) {
                showUploadStatus('error', 'ç½‘ç»œé”™è¯¯: ' + error.message);
            }
        }
        
        // æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€
        function showUploadStatus(status, message = '', novelId = '') {
            const statusContainer = document.getElementById('uploadStatus');
            
            if (status === 'uploading') {
                statusContainer.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>æ­£åœ¨ä¸Šä¼ å¹¶å¼€å§‹åˆ†æ...</p>
                    </div>
                `;
            } else if (status === 'success') {
                statusContainer.innerHTML = `
                    <div class="alert alert-success">
                        <strong>âœ… ${message}</strong><br>
                        å°è¯´ID: ${novelId}<br>
                        åˆ†æä»»åŠ¡å·²åœ¨åå°è¿è¡Œï¼Œè¯·ç¨åæŸ¥çœ‹ç»“æœã€‚
                    </div>
                `;
            } else if (status === 'error') {
                statusContainer.innerHTML = `
                    <div class="alert alert-error">
                        <strong>âŒ ${message}</strong>
                    </div>
                `;
            }
        }
        
        // åŠ è½½å°è¯´åˆ—è¡¨
        async function loadNovels() {
            const container = document.getElementById('novelsList');
            
            try {
                container.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                `;
                
                const response = await fetch('/api/novels');
                const data = await response.json();
                
                if (response.ok) {
                    displayNovels(data.novels);
                } else {
                    throw new Error(data.detail || 'åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="alert alert-error">
                        <strong>åŠ è½½å¤±è´¥: ${error.message}</strong>
                    </div>
                `;
            }
        }
        
        // æ˜¾ç¤ºå°è¯´åˆ—è¡¨
        function displayNovels(novels) {
            const container = document.getElementById('novelsList');
            
            if (novels.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 50px; color: #6c757d;">
                        <h3>æš‚æ— å°è¯´</h3>
                        <p>è¯·å…ˆä¸Šä¼ å°è¯´æ–‡ä»¶</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = novels.map(novel => {
                console.log('å¤„ç†å°è¯´:', novel);
                const novelId = novel._id || novel.id;
                const novelTitle = novel.title || 'æœªçŸ¥æ ‡é¢˜';
                
                if (!novelId) {
                    console.error('å°è¯´IDç¼ºå¤±:', novel);
                    return `
                        <div class="novel-card">
                            <div class="alert alert-error">
                                <strong>é”™è¯¯: å°è¯´IDç¼ºå¤±</strong>
                                <pre>${JSON.stringify(novel, null, 2)}</pre>
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div class="novel-card">
                        <div class="novel-title">
                            ${novelTitle}
                            <span class="status-badge status-${novel.status}">
                                ${getStatusText(novel.status)}
                            </span>
                        </div>
                        <div class="novel-meta">
                            ğŸ“… åˆ›å»ºæ—¶é—´: ${formatDate(novel.created_at)}
                            ğŸ“ å­—æ•°: ${novel.word_count?.toLocaleString() || 'æœªçŸ¥'}
                            ğŸ†” ID: ${novelId}
                        </div>
                        <div>
                        ${novel.status === 'completed' ? `
                            <button class="btn" onclick="viewAnalysis('${novelId}', '${novelTitle}')">
                                ğŸ“Š æŸ¥çœ‹åˆ†æ
                            </button>
                        ` : ''}
                        ${novel.status === 'processing' ? `
                            <button class="btn" onclick="showProgress('${novelId}')">
                                ğŸ“ˆ æŸ¥çœ‹è¿›åº¦
                            </button>
                        ` : ''}
                        ${novel.status === 'failed' || novel.status === 'pending' ? `
                            <button class="btn" onclick="retryAnalysis('${novelId}')">
                                ğŸ”„ é‡æ–°åˆ†æ
                            </button>
                        ` : ''}
                            <button class="btn btn-danger" onclick="deleteNovel('${novelId}', '${novelTitle}')">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'pending': 'ç­‰å¾…åˆ†æ',
                'processing': 'åˆ†æä¸­',
                'completed': 'å·²å®Œæˆ',
                'failed': 'åˆ†æå¤±è´¥'
            };
            return statusMap[status] || status;
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            return new Date(dateString).toLocaleString('zh-CN');
        }
        
        // è·å–åˆ†æå€¼ï¼Œæ”¯æŒå¤šä¸ªå¯èƒ½çš„å­—æ®µå
        function getAnalysisValue(analysis, possibleKeys) {
            if (!analysis) return 'N/A';
            
            for (const key of possibleKeys) {
                if (analysis[key] !== undefined && analysis[key] !== null && analysis[key] !== '') {
                    return analysis[key];
                }
            }
            
            return 'N/A';
        }
        
        // è·å–æ ‡ç­¾ï¼Œæ”¯æŒå¤šç§æ ¼å¼
        function getTags(analysis, possibleKeys) {
            if (!analysis) return '';
            
            let tags = [];
            
            for (const key of possibleKeys) {
                if (analysis[key]) {
                    if (Array.isArray(analysis[key])) {
                        tags = tags.concat(analysis[key]);
                    } else if (typeof analysis[key] === 'string') {
                        tags.push(analysis[key]);
                    }
                }
            }
            
            // å»é‡å¹¶é™åˆ¶æ•°é‡
            tags = [...new Set(tags)].slice(0, 10);
            
            if (tags.length === 0) {
                return '<span class="tag">æš‚æ— æ ‡ç­¾</span>';
            }
            
            return tags.map(tag => `<span class="tag">${tag}</span>`).join('');
        }
        
        // æ ¼å¼åŒ–äººç‰©æ•°æ®ï¼Œå¤„ç†å¯¹è±¡æ•°ç»„
        function formatCharacters(characters) {
            if (!characters) return 'N/A';
            
            if (Array.isArray(characters)) {
                return characters.map(char => {
                    if (typeof char === 'string') {
                        return char;
                    } else if (typeof char === 'object' && char !== null) {
                        // å°è¯•æå–äººç‰©åç§°
                        return char.name || char.character || char.title || JSON.stringify(char);
                    } else {
                        return String(char);
                    }
                }).join(', ');
            } else if (typeof characters === 'string') {
                return characters;
            } else {
                return String(characters);
            }
        }
        
        // æŸ¥çœ‹åˆ†æç»“æœ
        async function viewAnalysis(novelId, novelTitle) {
            console.log('æŸ¥çœ‹åˆ†æ:', novelId, novelTitle);
            currentNovelId = novelId;
            switchTab('analysis');
            await loadAnalysis(novelId, novelTitle);
        }
        
        // åŠ è½½åˆ†æç»“æœ
        async function loadAnalysis(novelId, novelTitle) {
            console.log('åŠ è½½åˆ†ææ•°æ®:', novelId, novelTitle);
            const container = document.getElementById('analysisContainer');
            
            if (!novelId || novelId === 'undefined') {
                container.innerHTML = `
                    <div class="alert alert-error">
                        <strong>é”™è¯¯: æ— æ•ˆçš„å°è¯´ID</strong>
                    </div>
                `;
                return;
            }
            
            try {
                container.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>åŠ è½½åˆ†æç»“æœä¸­...</p>
                    </div>
                `;
                
                // å¹¶è¡ŒåŠ è½½ä¸‰ä¸ªå±‚çº§çš„æ•°æ®
                const [bookResponse, groupResponse, chapterResponse] = await Promise.all([
                    fetch(`/api/novels/${novelId}/analysis/book`),
                    fetch(`/api/novels/${novelId}/analysis/group`),
                    fetch(`/api/novels/${novelId}/analysis/chapter`)
                ]);
                
                const bookData = bookResponse.ok ? await bookResponse.json() : null;
                const groupData = groupResponse.ok ? await groupResponse.json() : [];
                const chapterData = chapterResponse.ok ? await chapterResponse.json() : [];
                
                displayAnalysis(novelTitle, bookData, groupData, chapterData);
                
            } catch (error) {
                container.innerHTML = `
                    <div class="alert alert-error">
                        <strong>åŠ è½½å¤±è´¥: ${error.message}</strong>
                    </div>
                `;
            }
        }
        
        // æ˜¾ç¤ºåˆ†æç»“æœ
        function displayAnalysis(novelTitle, bookData, groupData, chapterData) {
            const container = document.getElementById('analysisContainer');
            
            let html = `
                <h2>ğŸ“Š ã€Š${novelTitle}ã€‹åˆ†ææŠ¥å‘Š</h2>
                
                <div class="analysis-tabs">
                    <div class="analysis-tab active" onclick="switchAnalysisTab('book')">ğŸ“– å…¨ä¹¦åˆ†æ</div>
                    <div class="analysis-tab" onclick="switchAnalysisTab('group')">ğŸ“‘ ç« ç»„åˆ†æ (${groupData.length}ç»„)</div>
                    <div class="analysis-tab" onclick="switchAnalysisTab('chapter')">ğŸ“„ ç« èŠ‚åˆ†æ (${chapterData.length}ç« )</div>
                </div>
            `;
            
            // å…¨ä¹¦åˆ†æ
            html += `<div id="book-analysis" class="analysis-content active">`;
            if (bookData && bookData.analysis) {
                const analysis = bookData.analysis;
                console.log('å…¨ä¹¦åˆ†ææ•°æ®:', analysis);
                
                html += `
                    <div class="analysis-summary">
                        <h3>ğŸ“š å…¨ä¹¦æ¦‚è¦</h3>
                        <p>${bookData.summary || bookData.book_summary || 'æš‚æ— æ¦‚è¦'}</p>
                    </div>
                    
                    <div class="analysis-stats">
                        <div class="stat-card">
                            <div class="stat-value">${analysis.main_storylines || 'N/A'}</div>
                            <div class="stat-label">ä¸»çº¿æ•°é‡</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${analysis.total_climax_points || 'N/A'}</div>
                            <div class="stat-label">é«˜æ½®ç‚¹æ•°é‡</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${analysis.character_count || 'N/A'}</div>
                            <div class="stat-label">äººç‰©æ•°é‡</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${analysis.rhythm_pattern || 'N/A'}</div>
                            <div class="stat-label">èŠ‚å¥æ¨¡å¼</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${analysis.protagonist_clarity || 'N/A'}</div>
                            <div class="stat-label">ä¸»è§’é²œæ˜åº¦</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${analysis.scene_adaptability || 'N/A'}</div>
                            <div class="stat-label">åœºæ™¯é€‚åº”æ€§</div>
                        </div>
                    </div>
                    
                    <div class="analysis-item">
                        <h4>ğŸ·ï¸ æ ¸å¿ƒæ ‡ç­¾</h4>
                        <div class="tags">
                            ${(analysis.core_tags || []).map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>
                    </div>
                    
                    <div class="analysis-item">
                        <h4>ğŸ“ˆ è¯¦ç»†æŒ‡æ ‡</h4>
                        <p><strong>å†²çªå¯†åº¦:</strong> ${analysis.avg_conflict_density || 'N/A'}</p>
                        <p><strong>äººç‰©å…³ç³»å¤æ‚åº¦:</strong> ${analysis.relationship_complexity || 'N/A'}</p>
                        <p><strong>åŠ¨ä½œäº‹ä»¶æ¯”ä¾‹:</strong> ${analysis.action_event_ratio || 'N/A'}</p>
                        <p><strong>ç‰¹æ•ˆéœ€æ±‚:</strong> ${analysis.special_effects_need || 'N/A'}</p>
                        <p><strong>æƒ…ç»ªå…±é¸£åº¦:</strong> ${analysis.emotional_resonance || 'N/A'}</p>
                        <p><strong>æ€§åˆ«å€¾å‘:</strong> ${analysis.gender_orientation || 'N/A'}</p>
                        <p><strong>ç›®æ ‡å¹´é¾„:</strong> ${analysis.target_age || 'N/A'}</p>
                    </div>
                    
                    <div class="analysis-item">
                        <h4>ğŸ” æ•°æ®è°ƒè¯•</h4>
                        <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin: 10px 0;">
                            <h5>å¯ç”¨å­—æ®µ:</h5>
                            <p>${Object.keys(analysis).join(', ')}</p>
                            
                            <h5>ä¸»è¦äººç‰©:</h5>
                            <p>${JSON.stringify(analysis.main_characters || analysis.characters || 'N/A', null, 2)}</p>
                            
                            <h5>ä¸»é¢˜æ ‡ç­¾:</h5>
                            <p>${JSON.stringify(analysis.themes || analysis.tags || analysis.keywords || 'N/A', null, 2)}</p>
                            
                            <details>
                                <summary>å®Œæ•´åˆ†ææ•°æ®</summary>
                                <pre style="max-height: 300px; overflow-y: auto;">${JSON.stringify(analysis, null, 2)}</pre>
                            </details>
                        </div>
                    </div>
                `;
            } else {
                html += `<div class="alert alert-error">æš‚æ— å…¨ä¹¦åˆ†ææ•°æ®</div>`;
            }
            html += `</div>`;
            
            // ç« ç»„åˆ†æ
            html += `<div id="group-analysis" class="analysis-content">`;
            if (groupData.length > 0) {
                groupData.forEach((group, index) => {
                    html += `
                        <div class="analysis-item">
                            <h4>ğŸ“‘ ç¬¬${index + 1}ç»„ (${group.group_id || 'N/A'})</h4>
                            <p><strong>æ¦‚è¦:</strong> ${group.summary || 'æš‚æ— æ¦‚è¦'}</p>
                            ${group.analysis ? `
                                <p><strong>åˆ†æ:</strong> ${JSON.stringify(group.analysis, null, 2)}</p>
                            ` : ''}
                        </div>
                    `;
                });
            } else {
                html += `<div class="alert alert-error">æš‚æ— ç« ç»„åˆ†ææ•°æ®</div>`;
            }
            html += `</div>`;
            
            // ç« èŠ‚åˆ†æ
            html += `<div id="chapter-analysis" class="analysis-content">`;
            if (chapterData.length > 0) {
            // ç« èŠ‚åˆ†é¡µå®¹å™¨
            html += `<div id="chapter-pagination-container">`;
            html += `<div class="pagination-controls">
                <div class="pagination-settings">
                    <label for="chapters-per-page">æ¯é¡µæ˜¾ç¤º:</label>
                    <select id="chapters-per-page" onchange="changeChaptersPerPage(this.value)">
                        <option value="3">3ç« </option>
                        <option value="5" selected>5ç« </option>
                        <option value="10">10ç« </option>
                        <option value="20">20ç« </option>
                    </select>
                </div>
            </div>`;
            html += `<div id="chapter-list"></div>`;
            html += `<div id="chapter-pagination"></div>`;
            html += `</div>`;
            } else {
                html += `<div class="alert alert-error">æš‚æ— ç« èŠ‚åˆ†ææ•°æ®</div>`;
            }
            html += `</div>`;
            
            container.innerHTML = html;
            
            // åˆå§‹åŒ–ç« èŠ‚åˆ†é¡µ
            if (chapterData.length > 0) {
                initChapterPagination(chapterData);
            }
        }
        
        // ç« èŠ‚åˆ†é¡µç›¸å…³å˜é‡
        let currentChapterPage = 1;
        let chaptersPerPage = 5;
        let allChapterData = [];
        
        // åˆå§‹åŒ–ç« èŠ‚åˆ†é¡µ
        function initChapterPagination(chapterData) {
            allChapterData = chapterData;
            currentChapterPage = 1;
            renderChapterPage();
            renderChapterPagination();
        }
        
        // æ¸²æŸ“ç« èŠ‚é¡µé¢ - ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µä¼˜åŒ–æ€§èƒ½
        function renderChapterPage() {
            const chapterList = document.getElementById('chapter-list');
            if (!chapterList) return;
            
            const startIndex = (currentChapterPage - 1) * chaptersPerPage;
            const endIndex = startIndex + chaptersPerPage;
            const currentChapters = allChapterData.slice(startIndex, endIndex);
            
            // ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µå‡å°‘DOMé‡ç»˜
            const fragment = document.createDocumentFragment();
            
            currentChapters.forEach((chapter, index) => {
                const globalIndex = startIndex + index;
                const item = document.createElement('div');
                item.className = 'analysis-item';
                item.innerHTML = `
                    <h4>ğŸ“„ ç¬¬${globalIndex + 1}ç«  (${chapter.segment_id || 'N/A'})</h4>
                    <p><strong>æ¦‚è¦:</strong> ${chapter.summary || 'æš‚æ— æ¦‚è¦'}</p>
                    ${chapter.main_characters ? `
                        <p><strong>ä¸»è¦äººç‰©:</strong> ${formatCharacters(chapter.main_characters)}</p>
                    ` : ''}
                    ${chapter.tags ? `
                        <div class="tags">
                            ${(Array.isArray(chapter.tags) ? chapter.tags : []).map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>
                    ` : ''}
                `;
                fragment.appendChild(item);
            });
            
            // ä¸€æ¬¡æ€§æ›´æ–°DOM
            chapterList.innerHTML = '';
            chapterList.appendChild(fragment);
        }
        
        // æ¸²æŸ“ç« èŠ‚åˆ†é¡µæ§ä»¶
        function renderChapterPagination() {
            const paginationContainer = document.getElementById('chapter-pagination');
            if (!paginationContainer) return;
            
            const totalPages = Math.ceil(allChapterData.length / chaptersPerPage);
            
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }
            
            let html = '<div class="pagination">';
            
            // ä¸Šä¸€é¡µæŒ‰é’®
            if (currentChapterPage > 1) {
                html += `<button class="pagination-btn" onclick="changeChapterPage(${currentChapterPage - 1})">ä¸Šä¸€é¡µ</button>`;
            }
            
            // é¡µç æŒ‰é’®
            const startPage = Math.max(1, currentChapterPage - 2);
            const endPage = Math.min(totalPages, currentChapterPage + 2);
            
            if (startPage > 1) {
                html += `<button class="pagination-btn" onclick="changeChapterPage(1)">1</button>`;
                if (startPage > 2) {
                    html += `<span class="pagination-ellipsis">...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === currentChapterPage ? 'active' : '';
                html += `<button class="pagination-btn ${isActive}" onclick="changeChapterPage(${i})">${i}</button>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<span class="pagination-ellipsis">...</span>`;
                }
                html += `<button class="pagination-btn" onclick="changeChapterPage(${totalPages})">${totalPages}</button>`;
            }
            
            // ä¸‹ä¸€é¡µæŒ‰é’®
            if (currentChapterPage < totalPages) {
                html += `<button class="pagination-btn" onclick="changeChapterPage(${currentChapterPage + 1})">ä¸‹ä¸€é¡µ</button>`;
            }
            
            html += '</div>';
            
            // æ·»åŠ é¡µé¢ä¿¡æ¯
            const startIndex = (currentChapterPage - 1) * chaptersPerPage + 1;
            const endIndex = Math.min(currentChapterPage * chaptersPerPage, allChapterData.length);
            html += `<div class="pagination-info">æ˜¾ç¤ºç¬¬ ${startIndex}-${endIndex} ç« ï¼Œå…± ${allChapterData.length} ç« </div>`;
            
            paginationContainer.innerHTML = html;
        }
        
        // åˆ‡æ¢ç« èŠ‚é¡µé¢ - ä½¿ç”¨requestAnimationFrameä¼˜åŒ–æ»šåŠ¨
        function changeChapterPage(page) {
            if (page < 1 || page > Math.ceil(allChapterData.length / chaptersPerPage)) return;
            
            currentChapterPage = page;
            renderChapterPage();
            renderChapterPagination();
            
            // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–æ»šåŠ¨æ€§èƒ½
            requestAnimationFrame(() => {
                const chapterAnalysis = document.getElementById('chapter-analysis');
                if (chapterAnalysis) {
                    chapterAnalysis.scrollIntoView({ behavior: 'smooth' });
                }
            });
        }
        
        // æ”¹å˜æ¯é¡µæ˜¾ç¤ºæ•°é‡
        function changeChaptersPerPage(newPerPage) {
            chaptersPerPage = parseInt(newPerPage);
            currentChapterPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
            renderChapterPage();
            renderChapterPagination();
        }
        
        // åˆ‡æ¢åˆ†ææ ‡ç­¾
        function switchAnalysisTab(level) {
            // æ›´æ–°æ ‡ç­¾
            document.querySelectorAll('.analysis-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // æ›´æ–°å†…å®¹
            document.querySelectorAll('.analysis-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${level}-analysis`).classList.add('active');
            
            currentAnalysisLevel = level;
        }
        
        // é‡æ–°åˆ†æ
        async function retryAnalysis(novelId) {
            if (!confirm('ç¡®å®šè¦é‡æ–°åˆ†æè¿™æœ¬å°è¯´å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/novels/analyze/${novelId}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('success', result.message);
                    loadNovels();
                } else {
                    showAlert('error', result.detail || 'é‡æ–°åˆ†æå¤±è´¥');
                }
            } catch (error) {
                showAlert('error', 'ç½‘ç»œé”™è¯¯: ' + error.message);
            }
        }
        
        // åˆ é™¤å°è¯´
        async function deleteNovel(novelId, novelTitle) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ã€Š${novelTitle}ã€‹åŠå…¶æ‰€æœ‰åˆ†æç»“æœå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
            
            try {
                const response = await fetch(`/api/novels/${novelId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('success', 'åˆ é™¤æˆåŠŸ');
                    loadNovels();
                    // å¦‚æœå½“å‰æ˜¾ç¤ºçš„å°±æ˜¯è¢«åˆ é™¤çš„å°è¯´ï¼Œæ¸…ç©ºåˆ†æé¡µé¢
                    if (currentNovelId === novelId) {
                        document.getElementById('analysisContainer').innerHTML = `
                            <div style="text-align: center; padding: 50px; color: #6c757d;">
                                <h3>è¯·å…ˆé€‰æ‹©ä¸€æœ¬å°è¯´æŸ¥çœ‹åˆ†æç»“æœ</h3>
                                <p>ä»å°è¯´åˆ—è¡¨ä¸­é€‰æ‹©å·²å®Œæˆåˆ†æçš„å°è¯´</p>
                            </div>
                        `;
                        currentNovelId = null;
                    }
                } else {
                    showAlert('error', result.detail || 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                showAlert('error', 'ç½‘ç»œé”™è¯¯: ' + error.message);
            }
        }
        
        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(type, message) {
            const alertHtml = `
                <div class="alert alert-${type === 'success' ? 'success' : 'error'}">
                    <strong>${type === 'success' ? 'âœ…' : 'âŒ'} ${message}</strong>
                </div>
            `;
            
            // åœ¨å½“å‰é¡µé¢é¡¶éƒ¨æ˜¾ç¤º
            const activeTab = document.querySelector('.tab-content.active');
            activeTab.insertAdjacentHTML('afterbegin', alertHtml);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                const alert = activeTab.querySelector('.alert');
                if (alert) alert.remove();
            }, 3000);
        }
        
        // æ˜¾ç¤ºåˆ†æè¿›åº¦
        async function showProgress(novelId) {
            try {
                const response = await fetch(`/api/novels/${novelId}/progress`);
                const progress = await response.json();
                
                if (response.ok) {
                    showProgressModal(novelId, progress);
                } else {
                    showAlert('error', 'è·å–è¿›åº¦å¤±è´¥');
                }
            } catch (error) {
                showAlert('error', 'ç½‘ç»œé”™è¯¯: ' + error.message);
            }
        }
        
        // æ˜¾ç¤ºè¿›åº¦æ¨¡æ€æ¡†
        function showProgressModal(novelId, progress) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content progress-modal">
                    <div class="modal-header">
                        <h3>ğŸ“ˆ åˆ†æè¿›åº¦</h3>
                        <button class="close" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress.progress}%"></div>
                            </div>
                            <div class="progress-text">${progress.progress}%</div>
                        </div>
                        <div class="progress-details">
                            <div class="progress-step">
                                <span class="step-label">å½“å‰æ­¥éª¤:</span>
                                <span class="step-value">${progress.current_step}</span>
                            </div>
                            <div class="progress-status">
                                <span class="status-label">çŠ¶æ€:</span>
                                <span class="status-value status-${progress.status}">${progress.status}</span>
                            </div>
                            <div class="progress-message">
                                <span class="message-label">è¯¦ç»†æ¶ˆæ¯:</span>
                                <span class="message-value">${progress.message}</span>
                            </div>
                            ${progress.timestamp ? `
                            <div class="progress-time">
                                <span class="time-label">æ›´æ–°æ—¶é—´:</span>
                                <span class="time-value">${new Date(progress.timestamp).toLocaleString('zh-CN')}</span>
                            </div>
                            ` : ''}
                        </div>
                        <div class="progress-actions">
                            <button class="btn btn-primary" onclick="refreshProgress('${novelId}')">
                                ğŸ”„ åˆ·æ–°è¿›åº¦
                            </button>
                            <button class="btn btn-info" onclick="debugProgress('${novelId}')">
                                ğŸ” è°ƒè¯•æ•°æ®
                            </button>
                            <button class="btn btn-secondary" onclick="closeModal()">
                                å…³é—­
                            </button>
                        </div>
                        <div class="progress-tips">
                            <p>ğŸ’¡ æç¤ºï¼šåˆ†æè¿‡ç¨‹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // è‡ªåŠ¨åˆ·æ–°è¿›åº¦ - ä½¿ç”¨èŠ‚æµä¼˜åŒ–
            const throttledRefresh = throttle(refreshProgress, 1000);
            const refreshInterval = setInterval(() => {
                throttledRefresh(novelId);
            }, 2000);
            
            // å­˜å‚¨åˆ·æ–°é—´éš”IDï¼Œç”¨äºæ¸…ç†
            modal.refreshInterval = refreshInterval;
        }
        
        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // èŠ‚æµå‡½æ•°
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }
        
        // åˆ·æ–°è¿›åº¦
        async function refreshProgress(novelId) {
            try {
                const response = await fetch(`/api/novels/${novelId}/progress`);
                const progress = await response.json();
                
                console.log('è¿›åº¦æ›´æ–°:', progress); // è°ƒè¯•ä¿¡æ¯
                
                if (response.ok) {
                    // æ›´æ–°è¿›åº¦æ¡
                    const progressFill = document.querySelector('.progress-fill');
                    const progressText = document.querySelector('.progress-text');
                    const stepValue = document.querySelector('.step-value');
                    const statusValue = document.querySelector('.status-value');
                    const messageValue = document.querySelector('.message-value');
                    const timeValue = document.querySelector('.time-value');
                    
                    if (progressFill) progressFill.style.width = `${progress.progress}%`;
                    if (progressText) progressText.textContent = `${progress.progress}%`;
                    if (stepValue) stepValue.textContent = progress.current_step;
                    if (statusValue) {
                        statusValue.textContent = progress.status;
                        statusValue.className = `status-value status-${progress.status}`;
                    }
                    if (messageValue) messageValue.textContent = progress.message;
                    if (timeValue && progress.timestamp) {
                        timeValue.textContent = new Date(progress.timestamp).toLocaleString('zh-CN');
                    }
                    
                    // å¦‚æœåˆ†æå®Œæˆï¼Œåœæ­¢åˆ·æ–°å¹¶å…³é—­æ¨¡æ€æ¡†
                    if (progress.status === 'completed' || progress.progress >= 100) {
                        const modal = document.querySelector('.modal');
                        if (modal && modal.refreshInterval) {
                            clearInterval(modal.refreshInterval);
                        }
                        setTimeout(() => {
                            closeModal();
                            loadNovels(); // åˆ·æ–°å°è¯´åˆ—è¡¨
                        }, 2000);
                    }
                }
            } catch (error) {
                console.error('åˆ·æ–°è¿›åº¦å¤±è´¥:', error);
            }
        }
        
        // è°ƒè¯•è¿›åº¦æ•°æ®
        async function debugProgress(novelId) {
            try {
                // è·å–å½“å‰è¿›åº¦
                const progressResponse = await fetch(`/api/novels/${novelId}/progress`);
                const progress = await progressResponse.json();
                
                // è·å–æ‰€æœ‰è¿›åº¦æ•°æ®
                const debugResponse = await fetch('/api/debug/progress');
                const debugData = await debugResponse.json();
                
                console.log('å½“å‰è¿›åº¦:', progress);
                console.log('æ‰€æœ‰è¿›åº¦æ•°æ®:', debugData);
                
                alert(`è°ƒè¯•ä¿¡æ¯:\nå½“å‰è¿›åº¦: ${JSON.stringify(progress, null, 2)}\n\næ‰€æœ‰æ•°æ®: ${JSON.stringify(debugData, null, 2)}`);
            } catch (error) {
                console.error('è°ƒè¯•å¤±è´¥:', error);
                alert('è°ƒè¯•å¤±è´¥: ' + error.message);
            }
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            const modal = document.querySelector('.modal');
            if (modal) {
                if (modal.refreshInterval) {
                    clearInterval(modal.refreshInterval);
                }
                document.body.removeChild(modal);
            }
        }
    </script>
</body>
</html>
